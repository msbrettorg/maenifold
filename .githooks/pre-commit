#!/bin/bash
set -e

echo "üîç Running pre-commit validation..."

# Check if we're on dev or main branch
BRANCH=$(git branch --show-current)

# Only run full validation on dev/main
if [[ "$BRANCH" != "dev" && "$BRANCH" != "main" ]]; then
  echo "‚úÖ Feature branch - skipping release validation"
  exit 0
fi

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "Release Validation (Branch: $BRANCH)"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Check package.json for optionalDependencies
if grep -q "optionalDependencies" package.json; then
  echo "‚ùå FAIL: package.json contains optionalDependencies"
  echo "This caused the v1.0.1 disaster. Remove it."
  exit 1
fi

# Check that bin/ is in files array
if ! grep -A 20 '"files":' package.json | grep -q '"bin/"'; then
  echo "‚ùå FAIL: package.json files array missing 'bin/'"
  echo "Binaries won't be included in npm package."
  exit 1
fi

# Check VS Code URLs in staged files
if git diff --cached --name-only | grep -E "(README.md|site/.*\.tsx)"; then
  if git diff --cached | grep -E "^\+" | grep -q "vscode:extension/mcp"; then
    echo "‚ùå FAIL: Attempting to commit wrong VS Code URL scheme"
    echo "Found: vscode:extension/mcp"
    echo "Should be: vscode:mcp/install OR insiders.vscode.dev/redirect/mcp/install"
    exit 1
  fi
fi

# If package.json is being modified, verify package contents
if git diff --cached --name-only | grep -q "package.json"; then
  echo "Verifying package contents..."
  if ! npm pack --dry-run 2>&1 | grep -q "bin/"; then
    echo "‚ùå FAIL: bin/ directory not included in package"
    echo "Run: npm pack --dry-run to verify"
    exit 1
  fi
fi

echo "‚úÖ All pre-commit checks passed"
exit 0

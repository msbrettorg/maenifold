{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Serverless SQL Storage - FinOps Audit"
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "azure monitor"
    }
  },
  "variables": {
    "workbookId": "[guid(resourceGroup().id, parameters('workbookDisplayName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2023-06-01",
      "name": "[variables('workbookId')]",
      "location": "[resourceGroup().location]",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "category": "workbook",
        "sourceId": "[parameters('workbookSourceId')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Serverless SQL storage audit\\nIdentifies allocated vs used storage across all serverless SQL databases (`GP_S_Gen*`) in the selected subscriptions. Allocated storage is what you're [billed for](https://learn.microsoft.com/en-us/azure/azure-sql/database/serverless-tier-overview#billing)\\u2014it grows with writes and doesn't auto-shrink. Compare the **Allocated** and **Used** columns to find reclamation targets.\"},\"name\":\"header\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"7b3c9e1a-4f2d-4a8b-9c6e-1d3f5a7b9c2e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscriptions\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"includeAll\":true,\"defaultValue\":\"value::all\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"includeAll\":true}},{\"id\":\"8d4e0f2b-5a3c-4b9d-ae7f-2e4a6b8c0d3f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type =~ 'microsoft.sql/servers/databases'\\n| where sku.name startswith 'GP_S_Gen'\\n| project id, dbName=name, serverName=tostring(split(id, '/')[8]),\\n    resourceGroup, subscriptionId, location,\\n    skuName=sku.name, maxSizeGB=properties.maxSizeBytes / 1073741824\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":5},{\"columnMatch\":\"subscriptionId\",\"formatter\":5},{\"columnMatch\":\"maxSizeGB\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}}],\"labelSettings\":[{\"columnId\":\"dbName\",\"label\":\"Database\"},{\"columnId\":\"serverName\",\"label\":\"Server\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource group\"},{\"columnId\":\"location\",\"label\":\"Region\"},{\"columnId\":\"skuName\",\"label\":\"SKU\"},{\"columnId\":\"maxSizeGB\",\"label\":\"Max size (GB)\"}]}},\"name\":\"serverlessDatabases\"},{\"type\":10,\"content\":{\"chartId\":\"c5e8a2f1-6b3d-4c9a-b7e2-3f5a1d8c4e6b\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":0,\"resourceType\":\"microsoft.sql/servers/databases\",\"metricScope\":0,\"resourceIds\":[\"resources\\n| where type =~ 'microsoft.sql/servers/databases'\\n| where sku.name startswith 'GP_S_Gen'\\n| project id\\n| order by id asc\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":86400000},\"metrics\":[{\"namespace\":\"microsoft.sql/servers/databases\",\"metric\":\"microsoft.sql/servers/databases--allocated_data_storage\",\"aggregation\":4,\"columnName\":\"Allocated\"},{\"namespace\":\"microsoft.sql/servers/databases\",\"metric\":\"microsoft.sql/servers/databases--storage\",\"aggregation\":4,\"columnName\":\"Used\"}],\"gridFormatType\":1,\"resourceLimit\":500,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Metric\",\"formatter\":5},{\"columnMatch\":\"Allocated\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Used\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Timeline\",\"formatter\":5},{\"columnMatch\":\"microsoft.sql/servers/databases--allocated_data_storage\",\"formatter\":5},{\"columnMatch\":\"microsoft.sql/servers/databases--storage\",\"formatter\":5}]}},\"conditionalVisibility\":{\"parameterName\":\"neverShow\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"storageMetrics\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\",\\\"mergeType\\\":\\\"leftouter\\\",\\\"leftTable\\\":\\\"serverlessDatabases\\\",\\\"rightTable\\\":\\\"storageMetrics\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[serverlessDatabases].dbName\\\",\\\"mergedName\\\":\\\"Database\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[serverlessDatabases].serverName\\\",\\\"mergedName\\\":\\\"Server\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[serverlessDatabases].location\\\",\\\"mergedName\\\":\\\"Region\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[serverlessDatabases].skuName\\\",\\\"mergedName\\\":\\\"SKU\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[serverlessDatabases].maxSizeGB\\\",\\\"mergedName\\\":\\\"Max size (GB)\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[storageMetrics].Allocated\\\",\\\"mergedName\\\":\\\"Allocated\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[storageMetrics].Used\\\",\\\"mergedName\\\":\\\"Used\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[serverlessDatabases].subscriptionId\\\",\\\"mergedName\\\":\\\"Subscription\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[serverlessDatabases].resourceGroup\\\",\\\"mergedName\\\":\\\"Resource group\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"},{\\\"originalName\\\":\\\"[serverlessDatabases].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"d9f2a1b3-7c4e-4d8a-b5f1-6e3a9c2d7b4f\\\"}]}\",\"size\":0,\"queryType\":7,\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":5},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Max size \\\\(GB\\\\)\",\"formatter\":0,\"numberFormat\":{\"unit\":5,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"Allocated\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Used\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}],\"sortBy\":[{\"itemKey\":\"Allocated\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Database\",\"label\":\"Database\"},{\"columnId\":\"Server\",\"label\":\"Server\"},{\"columnId\":\"Region\",\"label\":\"Region\"},{\"columnId\":\"SKU\",\"label\":\"SKU\"},{\"columnId\":\"Max size (GB)\",\"label\":\"Max size (GB)\"},{\"columnId\":\"Allocated\",\"label\":\"Allocated\"},{\"columnId\":\"Used\",\"label\":\"Used\"},{\"columnId\":\"Resource group\",\"label\":\"Resource group\"}]}},\"name\":\"mergedStorageView\"},{\"type\":1,\"content\":{\"json\":\"---\\n### How to read this table\\n- **Allocated** = storage you're [billed for](https://learn.microsoft.com/en-us/azure/azure-sql/database/serverless-tier-overview#billing). Grows with writes, never auto-shrinks.\\n- **Used** = actual data on disk.\\n- **Waste** = Allocated minus Used. Compare the two columns to find reclamation targets.\\n- **Max size (GB)** = configured ceiling. Reducing it doesn't reclaim allocated space.\\n- Run [`DBCC SHRINKDATABASE`](https://learn.microsoft.com/en-us/sql/t-sql/database-console-commands/dbcc-shrinkdatabase-transact-sql) to reclaim. Shrinking causes [index fragmentation](https://learn.microsoft.com/en-us/sql/relational-databases/indexes/reorganize-and-rebuild-indexes)\\u2014rebuild indexes after shrinking production databases.\\n- [Serverless compute tier overview](https://learn.microsoft.com/en-us/azure/azure-sql/database/serverless-tier-overview)\\n\\n> This workbook displays up to 500 databases. If you have more, filter by subscription using the picker above.\"},\"name\":\"footer\"}],\"fallbackResourceIds\":[\"azure monitor\"]}"
      }
    }
  ]
}

#!/bin/bash
set -e

echo "ğŸ” Running pre-commit validation..."

# Check if we're on dev or main branch
BRANCH=$(git branch --show-current)

# Only run full validation on dev/main
if [[ "$BRANCH" != "dev" && "$BRANCH" != "main" ]]; then
  echo "âœ… Feature branch - skipping release validation"
  exit 0
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Release Validation (Branch: $BRANCH)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check package.json for optionalDependencies
if grep -q "optionalDependencies" package.json; then
  echo "âŒ FAIL: package.json contains optionalDependencies"
  echo "This caused the v1.0.1 disaster. Remove it."
  exit 1
fi

# Check that bin/ is in files array
if ! grep -A 20 '"files":' package.json | grep -q '"bin/"'; then
  echo "âŒ FAIL: package.json files array missing 'bin/'"
  echo "Binaries won't be included in npm package."
  exit 1
fi

# Check VS Code URLs in staged files
if git diff --cached --name-only | grep -E "(README.md|site/.*\.tsx)"; then
  if git diff --cached | grep -E "^\+" | grep -q "vscode:extension/mcp"; then
    echo "âŒ FAIL: Attempting to commit wrong VS Code URL scheme"
    echo "Found: vscode:extension/mcp"
    echo "Should be: vscode:mcp/install OR insiders.vscode.dev/redirect/mcp/install"
    exit 1
  fi
fi

# Note: We don't check if bin/ physically exists because it's created
# by the release workflow, not committed to git. We only verify package.json
# is configured to include it.

echo "âœ… All pre-commit checks passed"
exit 0

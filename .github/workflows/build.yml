name: Build

on:
  push:
    branches: [commons, dev, main]
  pull_request:
    branches: [commons, dev, main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          lfs: true

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Clean up old test databases
        run: rm -rf /tmp/maenifold-test-root || true

      - run: dotnet restore src/Maenifold.csproj

      - run: dotnet build src/Maenifold.csproj --configuration Release --no-restore

      - name: Run tests with coverage
        run: >-
          dotnet test tests/Maenifold.Tests/Maenifold.Tests.csproj
          --configuration Release
          --verbosity normal
          --filter "FullyQualifiedName!~AssetDiscoveryAndRetrievalFlow_IsConsistent&FullyQualifiedName!~AllSearchModesRespectMinScore&FullyQualifiedName!~MinScoreOneReturnsOnlyPerfectMatches&FullyQualifiedName!~MinScoreZeroReturnsAllResults"

      - name: Coverage summary
        if: always()
        run: |
          REPORT="tests/Maenifold.Tests/coverage/coverage.cobertura.xml"
          if [ -f "$REPORT" ]; then
            LINE=$(xmllint --xpath 'string(//@line-rate)' "$REPORT")
            BRANCH=$(xmllint --xpath 'string(//@branch-rate)' "$REPORT")
            METHOD=$(xmllint --xpath 'string(//@lines-covered)' "$REPORT")
            TOTAL=$(xmllint --xpath 'string(//@lines-valid)' "$REPORT")
            LINE_PCT=$(awk "BEGIN {printf \"%.1f\", $LINE * 100}")
            BRANCH_PCT=$(awk "BEGIN {printf \"%.1f\", $BRANCH * 100}")
            echo "## Code Coverage" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Line | **${LINE_PCT}%** (${METHOD}/${TOTAL}) |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Branch | **${BRANCH_PCT}%** |" >> "$GITHUB_STEP_SUMMARY"
          fi

    # Known-failing tests excluded from CI (sqlite-vec search score behavior on Linux):
    # - AssetDiscoveryAndRetrievalFlow_IsConsistent
    # - AllSearchModesRespectMinScore / MinScoreOneReturnsOnlyPerfectMatches / MinScoreZeroReturnsAllResults
    # These pass locally on macOS but fail on ubuntu-latest due to sqlite-vec platform differences.
